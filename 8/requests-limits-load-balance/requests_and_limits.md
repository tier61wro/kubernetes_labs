https://go.skillbox.ru/education/course/devops-kubernetes/dcbfa571-4f9e-4973-9681-4cc8e56c78bf/videolesson

# 8.1 Запросы и лимиты:
1. Kube-scheduler - Работа планировщика
   1. Решает где запускать контейнер - оценивает ноды по множеству параметров и выбирает лучшую и записывает это в API

2. При установке лимитов при создании пода:
    ```
    apiVersion: v1
    kind: Pod
    metadata:
    name: nginx-pod
    spec:
    containers:
    - name: nginx
        image: nginx
        resources:
        limits:
            cpu: "200m"
            memory: "512Mi"
        requests:
            cpu: "100m"
            memory: "256Mi"
    ```
    1. Лимимы будут задавать требование для Kube-scheduler для выбора Ноды
    2. Если лимиты будут привышены при создании/работы пода - будет 2 события:
        1. Под будет убит с OOM ошибкой при нехватке памяти
        2. Время выполнения будет увеличено из-за ограничения процессора
        3. В зависимости от политики - Под будет перезапущен или убит с ошибкой.

3. `kubectl apply -f ./requests-limits-load-balance/8.1/nginx-limit-pod.yaml` - создать под с лимитами
4. `kubectl exec -it nginx-pod bash`, `time curl -s http://localhost?[1-10000] > /dev/null`:
```
real    0m10.315s
user    0m0.520s
sys     0m0.664s
```
5. `kubectl delete pod nginx-pod` (удаляем под), меняем лимиты пода:
```
resources:
    limits:
        cpu: "100m"
        memory: "100Mi"
    requests:
        cpu: "25m"
        memory: "50Mi"
```
6. `kubectl exec -it nginx-pod bash`, `time curl -s http://localhost?[1-10000] > /dev/null`:
```
real    0m29.581s
user    0m0.785s
sys     0m0.907s
```

## QOS-классы:
Определяют уровень гарантированности ресурсов, выделенных для контейнеров в подах. Они позволяют управлять приоритетами и гарантировать доступность ресурсов в случае нехватки.

### В Kubernetes существуют три типа QoS-классов:

Guaranteed (гарантированный) - этот класс гарантирует, что контейнер всегда будет иметь доступ к запрошенным ресурсам (CPU и память). Если ресурсы не могут быть выделены, то запуск контейнера не произойдет.

Burstable (переменный) - этот класс гарантирует, что контейнер имеет доступ к запрошенным ресурсам в большинстве случаев, но может быть ограничен в случае нехватки ресурсов на уровне кластера.

BestEffort (лучшие усилия) - этот класс не гарантирует никаких ресурсов, а просто использует доступные ресурсы на уровне кластера. Этот класс используется для приложений, которые могут работать в условиях ограниченных ресурсов.

Класс QoS для каждого пода в Kubernetes определяется на основе ресурсов, запрошенных контейнерами в поде. Если запрошенные ресурсы меньше или равны ресурсам, доступным на уровне кластера, то класс QoS для пода будет "Garanteed". Если запрошенные ресурсы больше, чем доступные на уровне кластера, но меньше или равны двойным ресурсам, класс QoS будет "Burstable". Если запрошенные ресурсы превышают двойные ресурсы, класс QoS будет "BestEffort".

### Создать несколько подов с разными классами: BestEffort, Guaranteed:
Для того чтобы проверить удаление подов при отсутствии памяти на ноде.
Какие классы будут присвоены подам и какие будут удалены?

1. `minikube start --cpus 2 --nodes 2 --memory 6144MB --driver=virtualbox` - создать minikube кластер, состоящий из 2 нод с заданными ресурсами
2. `kubectl get po -o json | jq '.items[] | .metadata.name + " " + .status.qosClass'` - проверить статус-классы подов:
```
"nginx-pod Burstable"
```
3. `minikube ssh -n minikube-m02`, зайти на ноду и найти контейнеры: `docker ps | grep cassandra | grep -v pause`
4. `docker ps | grep cassandra | grep -v pause | awk '{print $1}'`:
```
4e664f742f78
```
5. docker stats `docker ps | grep nginx | grep -v pause | awk '{print $1}'` - мониторинг состояния потребления ресурсов контейнером на ноде
6. `minikube cp /usr/bin/pv minikube-m02:/usr/bin/pv` - скопировать утилиту pv на ноду
7. `watch free -m` - мониторинг свободного места на ноде
8. `</dev/zero head -c 3000m | pv -L 100m | tail` - из блока `</dev/zero` вычитаем 3Гб блоками по 100мб
